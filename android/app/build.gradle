// D:\mobile\android\app\build.gradle  — React Native + Expo (AGP 8.x)

import java.util.Properties
import java.io.FileInputStream

apply plugin: "com.android.application"
apply plugin: "org.jetbrains.kotlin.android"
apply plugin: "com.facebook.react"  // bundles the JS for release builds

// --- Optional: load release keystore if present (../keystore.properties) ---
def keystorePropertiesFile = rootProject.file("../keystore.properties")
def keystoreProperties = new Properties()
if (keystorePropertiesFile.exists()) {
  keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
}

// --- React Native / Expo plugin config ---
def projectRoot = rootDir.getAbsoluteFile().getParentFile().getAbsolutePath()
react {
  // Resolve entry via Expo helper
  entryFile = file([
    "node", "-e",
    "require('expo/scripts/resolveAppEntry')",
    projectRoot, "android", "absolute"
  ].execute(null, rootDir).text.trim())

  // Paths to RN / Codegen / Hermes from node_modules
  reactNativeDir = new File([
    "node", "--print",
    "require.resolve('react-native/package.json')"
  ].execute(null, rootDir).text.trim()).getParentFile().getAbsoluteFile()

  hermesCommand = new File([
    "node", "--print",
    "require.resolve('react-native/package.json')"
  ].execute(null, rootDir).text.trim()).getParentFile().getAbsolutePath() + "/sdks/hermesc/%OS-BIN%/hermesc"

  codegenDir = new File([
    "node", "--print",
    "require.resolve('@react-native/codegen/package.json', { paths: [require.resolve('react-native/package.json')] })"
  ].execute(null, rootDir).text.trim()).getParentFile().getAbsoluteFile()

  // Use Expo CLI to bundle (respects Expo’s Metro config)
  cliFile       = new File([
    "node", "--print",
    "require.resolve('@expo/cli', { paths: [require.resolve('expo/package.json')] })"
  ].execute(null, rootDir).text.trim())
  bundleCommand = "export:embed"

  enableBundleCompression = (findProperty('android.enableBundleCompression') ?: false).toBoolean()

  // Autolink RN libs
  autolinkLibrariesWithApp()
}

// Toggle shrinking via gradle.properties if you want
def enableMinifyInReleaseBuilds = (findProperty('android.enableMinifyInReleaseBuilds') ?: 'false').toBoolean()

// JSC fallback when Hermes is disabled
def jscFlavor = 'io.github.react-native-community:jsc-android:2026004.+'

android {
  namespace "com.printechs.erpnext"

  // Match the Expo root printed values
  compileSdkVersion 36

  defaultConfig {
    applicationId "com.printechs.erpnext"
    minSdkVersion 24         // <-- bumped from 23 to 24
    targetSdkVersion 36
    versionCode 1
    versionName "1.0.0"

    buildConfigField "String", "REACT_NATIVE_RELEASE_LEVEL", "\"${findProperty('reactNativeReleaseLevel') ?: 'stable'}\""
  }

  signingConfigs {
    debug {
      storeFile file('debug.keystore')
      storePassword 'android'
      keyAlias 'androiddebugkey'
      keyPassword 'android'
    }
    // Real release signing if keystore.properties exists
    if (keystorePropertiesFile.exists()) {
      release {
        storeFile file(keystoreProperties['storeFile'])
        storePassword keystoreProperties['storePassword']
        keyAlias keystoreProperties['keyAlias']
        keyPassword keystoreProperties['keyPassword']
      }
    }
  }

  buildTypes {
    debug {
      signingConfig signingConfigs.debug
      // Debug builds expect Metro unless you bundle manually.
    }
    release {
      // If you don't have a keystore yet, fall back to debug signing to test
      signingConfig keystorePropertiesFile.exists() ? signingConfigs.release : signingConfigs.debug

      // Shrink/minify toggles
      def enableShrinkResources = (findProperty('android.enableShrinkResourcesInReleaseBuilds') ?: 'false').toBoolean()
      shrinkResources enableShrinkResources
      minifyEnabled enableMinifyInReleaseBuilds

      // Optimize rules (AGP 8.x)
      proguardFiles getDefaultProguardFile("proguard-android-optimize.txt"), "proguard-rules.pro"
    }
  }

  // Simple packaging defaults
  packagingOptions {
    resources {
      excludes += [ "META-INF/LICENSE*", "META-INF/NOTICE*", "META-INF/DEPENDENCIES" ]
    }
  }

  androidResources {
    ignoreAssetsPattern '!.svn:!.git:!.ds_store:!*.scc:!CVS:!thumbs.db:!picasa.ini:!*~'
  }
}

dependencies {
  // Managed by the RN Gradle plugin
  implementation("com.facebook.react:react-android")

  if (hermesEnabled.toBoolean()) {
    implementation("com.facebook.react:hermes-android")
  } else {
    implementation jscFlavor
  }
}
